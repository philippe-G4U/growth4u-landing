---
import '../styles/global.css';
import { GA4_ID, TRUSTPILOT_BU_ID, SITE_NAME, SITE_URL, SITE_DESCRIPTION, OG_IMAGE, FAVICON, LINKEDIN_URL } from '../lib/constants';

interface Props {
  title?: string;
  description?: string;
  canonical?: string;
  ogImage?: string;
  ogType?: string;
  locale?: string;
  noindex?: boolean;
  jsonLd?: Record<string, any>[];
}

const {
  title = `${SITE_NAME} | Growth Marketing Fintech B2B & B2C`,
  description = SITE_DESCRIPTION,
  canonical,
  ogImage = OG_IMAGE,
  ogType = 'website',
  locale = 'es',
  noindex = false,
  jsonLd = [],
} = Astro.props;

const canonicalUrl = canonical ? new URL(canonical, SITE_URL).href : new URL(Astro.url.pathname, SITE_URL).href;
const lang = locale === 'en' ? 'en' : 'es';
const ogLocale = locale === 'en' ? 'en_US' : 'es_ES';

// Organization schema - always present (matches existing Next.js exactly)
const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: 'Growth4U',
  url: SITE_URL,
  logo: OG_IMAGE,
  sameAs: [LINKEDIN_URL],
};
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Title & Description -->
    <title>{title}</title>
    <meta name="description" content={description} />

    <!-- Favicon -->
    <link rel="icon" href={FAVICON} />

    <!-- Canonical -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- Hreflang (i18n) -->
    <link rel="alternate" hreflang="es" href={new URL(Astro.url.pathname.replace(/^\/en/, ''), SITE_URL).href} />
    <link rel="alternate" hreflang="en" href={new URL(`/en${Astro.url.pathname.replace(/^\/en/, '')}`, SITE_URL).href} />
    <link rel="alternate" hreflang="x-default" href={new URL(Astro.url.pathname.replace(/^\/en/, ''), SITE_URL).href} />

    <!-- Robots -->
    {noindex ? (
      <meta name="robots" content="noindex, nofollow" />
    ) : (
      <meta name="robots" content="index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1" />
    )}

    <!-- Open Graph -->
    <meta property="og:type" content={ogType} />
    <meta property="og:locale" content={ogLocale} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content={SITE_NAME} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={SITE_NAME} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Google Analytics 4 -->
    <script is:inline src={`https://www.googletagmanager.com/gtag/js?id=${GA4_ID}`} async></script>
    <script is:inline define:vars={{ GA4_ID }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', GA4_ID);
    </script>

    <!-- Organization Schema (always present) -->
    <script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />

    <!-- Additional JSON-LD schemas (per-page) -->
    {jsonLd.map((schema) => (
      <script type="application/ld+json" set:html={JSON.stringify(schema)} />
    ))}

    <!-- Trustpilot Invitation SDK -->
    <script is:inline define:vars={{ TRUSTPILOT_BU_ID }}>
      (function(w,d,s,r,n){w.TrustpilotObject=n;w[n]=w[n]||function(){(w[n].q=w[n].q||[]).push(arguments)};
      a=d.createElement(s);a.async=1;a.src=r;a.type='text/java'+s;f=d.getElementsByTagName(s)[0];
      f.parentNode.insertBefore(a,f)})(window,document,'script','https://invitejs.trustpilot.com/tp.min.js','tp');
      tp('register', TRUSTPILOT_BU_ID);
    </script>
  </head>
  <body class="antialiased">
    <slot />
  </body>
</html>
