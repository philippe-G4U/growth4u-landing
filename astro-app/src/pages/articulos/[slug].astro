---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleGate from '../../react/ArticleGate';
import { getAllArticles, getArticleBySlug } from '../../lib/firebase-fetch';
import { SITE_URL, BOOKING_LINK } from '../../lib/constants';

export async function getStaticPaths() {
  const articles = await getAllArticles();
  return articles.map((article) => ({ params: { slug: article.slug } }));
}

const { slug } = Astro.params;
const article = await getArticleBySlug(slug as string);

if (!article) {
  return Astro.redirect('/404/');
}

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: article.title,
  description: article.excerpt,
  image: article.image,
  datePublished: article.createdAt || new Date().toISOString(),
  author: { '@type': 'Person', name: article.author },
  publisher: {
    '@type': 'Organization',
    name: 'Growth4U',
    logo: { '@type': 'ImageObject', url: 'https://i.imgur.com/imHxGWI.png' },
  },
};

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: SITE_URL },
    { '@type': 'ListItem', position: 2, name: 'Artículos', item: `${SITE_URL}/articulos/` },
    { '@type': 'ListItem', position: 3, name: article.title, item: `${SITE_URL}/articulos/${article.slug}/` },
  ],
};
---

<BaseLayout
  title={`${article.title} | Growth4U`}
  description={article.excerpt}
  ogImage={article.image}
  ogType="article"
  jsonLd={[articleSchema, breadcrumbSchema]}
>
  <!-- Nav -->
  <nav class="fixed w-full z-50 bg-white/90 backdrop-blur-md border-b border-slate-100">
    <div class="max-w-4xl mx-auto px-4 h-20 flex items-center justify-between">
      <a href="/articulos/" class="flex items-center gap-0 cursor-pointer">
        <img src="https://i.imgur.com/imHxGWI.png" alt="Growth4U" width="133" height="20" class="h-6 w-auto" />
      </a>
      <a href="/articulos/" class="text-sm font-bold text-[#6351d5] flex items-center gap-2 hover:underline">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
        Volver
      </a>
    </div>
  </nav>

  <article class="pt-32 pb-20 max-w-3xl mx-auto px-4">
    <span class="inline-block px-3 py-1 bg-[#6351d5]/10 text-[#6351d5] rounded-full text-xs font-bold uppercase tracking-wider mb-6">
      {article.category}
    </span>
    <h1 class="text-4xl md:text-5xl font-extrabold mb-6 text-[#032149] leading-tight">{article.title}</h1>
    <div class="flex items-center gap-4 text-slate-500 text-sm mb-8 border-b border-slate-100 pb-8">
      <span class="flex items-center gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        {article.readTime}
      </span>
      <span>&bull;</span>
      <span>{article.author}</span>
      {article.createdAt && (
        <>
          <span>&bull;</span>
          <span>{new Date(article.createdAt).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
        </>
      )}
    </div>

    {article.image && (
      <img src={article.image} alt={article.title} class="w-full h-auto object-cover rounded-3xl shadow-xl mb-12" loading="lazy" />
    )}

    <!-- ArticleGate: shows excerpt + blur + form gate, then reveals full content -->
    <ArticleGate
      client:only="react"
      excerpt={article.excerpt}
      articleSlug={article.slug}
      articleTitle={article.title}
      articleId={article.id}
    />

    <!-- CTA -->
    <div class="mt-16 pt-10 border-t border-slate-200 text-center">
      <h3 class="text-2xl font-bold mb-6">¿Quieres aplicar esto en tu Fintech?</h3>
      <a
        href={BOOKING_LINK}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center justify-center gap-2 bg-[#6351d5] hover:bg-[#3f45fe] text-white font-bold py-4 px-8 rounded-full shadow-lg transition-all transform hover:scale-105"
      >
        Agendar Llamada
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
      </a>
    </div>
  </article>
</BaseLayout>
